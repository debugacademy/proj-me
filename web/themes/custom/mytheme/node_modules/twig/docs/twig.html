<!DOCTYPE html>

<html>
<head>
  <title>twig.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>twig.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * Twig.js 0.8.9
 *
 * @copyright 2011-2015 John Roepke and the Twig.js Contributors
 * @license   Available under the BSD 2-Clause License
 * @link      https://github.com/justjohn/twig.js
 */</span>

<span class="hljs-keyword">var</span> Twig = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Twig</span>) </span>{

    Twig.VERSION = <span class="hljs-string">"0.8.9"</span>;

    <span class="hljs-keyword">return</span> Twig;
})(Twig || {});</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <pre><code>Twig.js
Available under the BSD <span class="hljs-number">2</span>-Clause License
https:<span class="hljs-comment">//github.com/justjohn/twig.js</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Twig = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Twig</span>) </span>{
<span class="hljs-meta">    "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="twig-core-js">twig.core.js</h2>
<p>This file handles template level tokenizing, compiling and parsing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    Twig.trace = <span class="hljs-literal">false</span>;
    Twig.debug = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Default caching to true for the improved performance it offers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.cache = <span class="hljs-literal">true</span>;

    Twig.placeholders = {
        parent: <span class="hljs-string">"{{|PARENT|}}"</span>
    };

    <span class="hljs-comment">/**
     * Fallback for Array.indexOf for IE8 et al
     */</span>
    Twig.indexOf = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, searchElement <span class="hljs-comment">/*, fromIndex */</span> </span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.prototype.hasOwnProperty(<span class="hljs-string">"indexOf"</span>)) {
            <span class="hljs-keyword">return</span> arr.indexOf(searchElement);
        }
        <span class="hljs-keyword">if</span> (arr === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> || arr === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>();
        }
        <span class="hljs-keyword">var</span> t = <span class="hljs-built_in">Object</span>(arr);
        <span class="hljs-keyword">var</span> len = t.length &gt;&gt;&gt; <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (len === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        }
        <span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">0</span>) {
            n = <span class="hljs-built_in">Number</span>(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]);
            <span class="hljs-keyword">if</span> (n !== n) { <span class="hljs-comment">// shortcut for verifying if it's NaN</span>
                n = <span class="hljs-number">0</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n !== <span class="hljs-number">0</span> &amp;&amp; n !== <span class="hljs-literal">Infinity</span> &amp;&amp; n !== -<span class="hljs-literal">Infinity</span>) {
                n = (n &gt; <span class="hljs-number">0</span> || <span class="hljs-number">-1</span>) * <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.abs(n));
            }
        }
        <span class="hljs-keyword">if</span> (n &gt;= len) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>console.log(“indexOf not found1 “, JSON.stringify(searchElement), JSON.stringify(arr));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        }
        <span class="hljs-keyword">var</span> k = n &gt;= <span class="hljs-number">0</span> ? n : <span class="hljs-built_in">Math</span>.max(len - <span class="hljs-built_in">Math</span>.abs(n), <span class="hljs-number">0</span>);
        <span class="hljs-keyword">for</span> (; k &lt; len; k++) {
            <span class="hljs-keyword">if</span> (k <span class="hljs-keyword">in</span> t &amp;&amp; t[k] === searchElement) {
                <span class="hljs-keyword">return</span> k;
            }
        }
        <span class="hljs-keyword">if</span> (arr == searchElement) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>console.log(“indexOf not found2 “, JSON.stringify(searchElement), JSON.stringify(arr));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    Twig.forEach = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, callback, thisArg</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.prototype.forEach ) {
            <span class="hljs-keyword">return</span> arr.forEach(callback, thisArg);
        }

        <span class="hljs-keyword">var</span> T, k;

        <span class="hljs-keyword">if</span> ( arr == <span class="hljs-literal">null</span> ) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>( <span class="hljs-string">" this is null or not defined"</span> );
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <ol>
<li>Let O be the result of calling ToObject passing the |this| value as the argument.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> O = <span class="hljs-built_in">Object</span>(arr);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <ol>
<li>Let lenValue be the result of calling the Get internal method of O with the argument “length”.</li>
<li>Let len be ToUint32(lenValue).</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> len = O.length &gt;&gt;&gt; <span class="hljs-number">0</span>; <span class="hljs-comment">// Hack to convert O.length to a UInt32</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <ol>
<li>If IsCallable(callback) is false, throw a TypeError exception.
See: <a href="http://es5.github.com/#x9.11">http://es5.github.com/#x9.11</a></li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( {}.toString.call(callback) != <span class="hljs-string">"[object Function]"</span> ) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>( callback + <span class="hljs-string">" is not a function"</span> );
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <ol>
<li>If thisArg was supplied, let T be thisArg; else let T be undefined.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( thisArg ) {
          T = thisArg;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <ol>
<li>Let k be 0</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        k = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ol>
<li>Repeat, while k &lt; len</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">while</span>( k &lt; len ) {

          <span class="hljs-keyword">var</span> kValue;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>a. Let Pk be ToString(k).
  This is implicit for LHS operands of the in operator
b. Let kPresent be the result of calling the HasProperty internal method of O with argument Pk.
  This step can be combined with c
c. If kPresent is true, then</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( k <span class="hljs-keyword">in</span> O ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>i. Let kValue be the result of calling the Get internal method of O with argument Pk.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            kValue = O[ k ];</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>ii. Call the Call internal method of callback with T as the this value and
argument list containing kValue, k, and O.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            callback.call( T, kValue, k, O );
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>d. Increase k by 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          k++;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ol>
<li>return undefined</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    };

    Twig.merge = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">target, source, onlyChanged</span>) </span>{
        Twig.forEach(<span class="hljs-built_in">Object</span>.keys(source), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{
            <span class="hljs-keyword">if</span> (onlyChanged &amp;&amp; !(key <span class="hljs-keyword">in</span> target)) {
                <span class="hljs-keyword">return</span>;
            }

            target[key] = source[key]
        });

        <span class="hljs-keyword">return</span> target;
    };

    <span class="hljs-comment">/**
     * Exception thrown by twig.js.
     */</span>
    Twig.Error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
       <span class="hljs-keyword">this</span>.message = message;
       <span class="hljs-keyword">this</span>.name = <span class="hljs-string">"TwigException"</span>;
       <span class="hljs-keyword">this</span>.type = <span class="hljs-string">"TwigException"</span>;
    };

    <span class="hljs-comment">/**
     * Get the string representation of a Twig error.
     */</span>
    Twig.Error.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> output = <span class="hljs-keyword">this</span>.name + <span class="hljs-string">": "</span> + <span class="hljs-keyword">this</span>.message;

        <span class="hljs-keyword">return</span> output;
    };

    <span class="hljs-comment">/**
     * Wrapper for logging to the console.
     */</span>
    Twig.log = {
        trace: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<span class="hljs-keyword">if</span> (Twig.trace &amp;&amp; <span class="hljs-built_in">console</span>) {<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>));}},
        debug: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<span class="hljs-keyword">if</span> (Twig.debug &amp;&amp; <span class="hljs-built_in">console</span>) {<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>));}}
    };


    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">console</span> !== <span class="hljs-string">"undefined"</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">console</span>.error !== <span class="hljs-string">"undefined"</span>) {
            Twig.log.error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-built_in">console</span>.error.apply(<span class="hljs-built_in">console</span>, <span class="hljs-built_in">arguments</span>);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">console</span>.log !== <span class="hljs-string">"undefined"</span>) {
            Twig.log.error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-built_in">console</span>.log.apply(<span class="hljs-built_in">console</span>, <span class="hljs-built_in">arguments</span>);
            }
        }
    } <span class="hljs-keyword">else</span> {
        Twig.log.error = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{};
    }

    <span class="hljs-comment">/**
     * Wrapper for child context objects in Twig.
     *
     * @param {Object} context Values to initialize the context with.
     */</span>
    Twig.ChildContext = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">context</span>) </span>{
        <span class="hljs-keyword">var</span> ChildContext = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ChildContext</span>(<span class="hljs-params"></span>) </span>{};
        ChildContext.prototype = context;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ChildContext();
    };

    <span class="hljs-comment">/**
     * Container for methods related to handling high level template tokens
     *      (for example: {{ expression }}, {% logic %}, {# comment #}, raw data)
     */</span>
    Twig.token = {};

    <span class="hljs-comment">/**
     * Token types.
     */</span>
    Twig.token.type = {
        output:                 <span class="hljs-string">'output'</span>,
        logic:                  <span class="hljs-string">'logic'</span>,
        comment:                <span class="hljs-string">'comment'</span>,
        raw:                    <span class="hljs-string">'raw'</span>,
        output_whitespace_pre:  <span class="hljs-string">'output_whitespace_pre'</span>,
        output_whitespace_post: <span class="hljs-string">'output_whitespace_post'</span>,
        output_whitespace_both: <span class="hljs-string">'output_whitespace_both'</span>,
        logic_whitespace_pre:   <span class="hljs-string">'logic_whitespace_pre'</span>,
        logic_whitespace_post:  <span class="hljs-string">'logic_whitespace_post'</span>,
        logic_whitespace_both:  <span class="hljs-string">'logic_whitespace_both'</span>
    };

    <span class="hljs-comment">/**
     * Token syntax definitions.
     */</span>
    Twig.token.definitions = [
        {
            type: Twig.token.type.raw,
            open: <span class="hljs-string">'{% raw %}'</span>,
            close: <span class="hljs-string">'{% endraw %}'</span>
        },
        {
            type: Twig.token.type.raw,
            open: <span class="hljs-string">'{% verbatim %}'</span>,
            close: <span class="hljs-string">'{% endverbatim %}'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><em>Whitespace type tokens</em></p>
<p>These typically take the form <code>{{- expression -}}</code> or <code>{{- expression }}</code> or <code>{{ expression -}}</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.token.type.output_whitespace_pre,
            open: <span class="hljs-string">'{{-'</span>,
            close: <span class="hljs-string">'}}'</span>
        },
        {
            type: Twig.token.type.output_whitespace_post,
            open: <span class="hljs-string">'{{'</span>,
            close: <span class="hljs-string">'-}}'</span>
        },
        {
            type: Twig.token.type.output_whitespace_both,
            open: <span class="hljs-string">'{{-'</span>,
            close: <span class="hljs-string">'-}}'</span>
        },
        {
            type: Twig.token.type.logic_whitespace_pre,
            open: <span class="hljs-string">'{%-'</span>,
            close: <span class="hljs-string">'%}'</span>
        },
        {
            type: Twig.token.type.logic_whitespace_post,
            open: <span class="hljs-string">'{%'</span>,
            close: <span class="hljs-string">'-%}'</span>
        },
        {
            type: Twig.token.type.logic_whitespace_both,
            open: <span class="hljs-string">'{%-'</span>,
            close: <span class="hljs-string">'-%}'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><em>Output type tokens</em></p>
<p>These typically take the form <code>{{ expression }}</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.token.type.output,
            open: <span class="hljs-string">'{{'</span>,
            close: <span class="hljs-string">'}}'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><em>Logic type tokens</em></p>
<p>These typically take a form like <code>{% if expression %}</code> or <code>{% endif %}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.token.type.logic,
            open: <span class="hljs-string">'{%'</span>,
            close: <span class="hljs-string">'%}'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><em>Comment type tokens</em></p>
<p>These take the form <code>{# anything #}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.token.type.comment,
            open: <span class="hljs-string">'{#'</span>,
            close: <span class="hljs-string">'#}'</span>
        }
    ];


    <span class="hljs-comment">/**
     * What characters start "strings" in token definitions. We need this to ignore token close
     * strings inside an expression.
     */</span>
    Twig.token.strings = [<span class="hljs-string">'"'</span>, <span class="hljs-string">"'"</span>];

    Twig.token.findStart = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">template</span>) </span>{
        <span class="hljs-keyword">var</span> output = {
                position: <span class="hljs-literal">null</span>,
                close_position: <span class="hljs-literal">null</span>,
                def: <span class="hljs-literal">null</span>
            },
            i,
            token_template,
            first_key_position,
            close_key_position;

        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;Twig.token.definitions.length;i++) {
            token_template = Twig.token.definitions[i];
            first_key_position = template.indexOf(token_template.open);
            close_key_position = template.indexOf(token_template.close);

            Twig.log.trace(<span class="hljs-string">"Twig.token.findStart: "</span>, <span class="hljs-string">"Searching for "</span>, token_template.open, <span class="hljs-string">" found at "</span>, first_key_position);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Special handling for mismatched tokens</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (first_key_position &gt;= <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>This token matches the template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (token_template.open.length !== token_template.close.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>This token has mismatched closing and opening tags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (close_key_position &lt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>This token’s closing tag does not match the template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">continue</span>;
                    }
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Does this token occur before any other types?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (first_key_position &gt;= <span class="hljs-number">0</span> &amp;&amp; (output.position === <span class="hljs-literal">null</span> || first_key_position &lt; output.position)) {
                output.position = first_key_position;
                output.def = token_template;
                output.close_position = close_key_position;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (first_key_position &gt;= <span class="hljs-number">0</span> &amp;&amp; output.position !== <span class="hljs-literal">null</span> &amp;&amp; first_key_position === output.position) {
                <span class="hljs-comment">/*This token exactly matches another token,
                greedily match to check if this token has a greater specificity*/</span>
                <span class="hljs-keyword">if</span> (token_template.open.length &gt; output.def.open.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>This token’s opening tag is more specific than the previous match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    output.position = first_key_position;
                    output.def = token_template;
                    output.close_position = close_key_position;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token_template.open.length === output.def.open.length) {
                    <span class="hljs-keyword">if</span> (token_template.close.length &gt; output.def.close.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>This token’s opening tag is as specific as the previous match,
but the closing tag has greater specificity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (close_key_position &gt;= <span class="hljs-number">0</span> &amp;&amp; close_key_position &lt; output.close_position) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>This token’s closing tag exists in the template,
and it occurs sooner than the previous match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            output.position = first_key_position;
                            output.def = token_template;
                            output.close_position = close_key_position;
                        }
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (close_key_position &gt;= <span class="hljs-number">0</span> &amp;&amp; close_key_position &lt; output.close_position) {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>This token’s closing tag is not more specific than the previous match,
but it occurs sooner than the previous match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        output.position = first_key_position;
                        output.def = token_template;
                        output.close_position = close_key_position;
                    }
                }
            }
        }

        <span class="hljs-keyword">delete</span> output[<span class="hljs-string">'close_position'</span>];

        <span class="hljs-keyword">return</span> output;
    };

    Twig.token.findEnd = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">template, token_def, start</span>) </span>{
        <span class="hljs-keyword">var</span> end = <span class="hljs-literal">null</span>,
            found = <span class="hljs-literal">false</span>,
            offset = <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>String position variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            str_pos = <span class="hljs-literal">null</span>,
            str_found = <span class="hljs-literal">null</span>,
            pos = <span class="hljs-literal">null</span>,
            end_offset = <span class="hljs-literal">null</span>,
            this_str_pos = <span class="hljs-literal">null</span>,
            end_str_pos = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>For loop variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            i,
            l;

        <span class="hljs-keyword">while</span> (!found) {
            str_pos = <span class="hljs-literal">null</span>;
            str_found = <span class="hljs-literal">null</span>;
            pos = template.indexOf(token_def.close, offset);

            <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>) {
                end = pos;
                found = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>throw an exception</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">"Unable to find closing bracket '"</span> + token_def.close +
                                <span class="hljs-string">"'"</span> + <span class="hljs-string">" opened near template position "</span> + start);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Ignore quotes within comments; just look for the next comment close sequence,
regardless of what comes before it. <a href="https://github.com/justjohn/twig.js/issues/95">https://github.com/justjohn/twig.js/issues/95</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (token_def.type === Twig.token.type.comment) {
              <span class="hljs-keyword">break</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Ignore quotes within raw tag
Fixes #283</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (token_def.type === Twig.token.type.raw) {
                <span class="hljs-keyword">break</span>;
            }

            l = Twig.token.strings.length;
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; l; i += <span class="hljs-number">1</span>) {
                this_str_pos = template.indexOf(Twig.token.strings[i], offset);

                <span class="hljs-keyword">if</span> (this_str_pos &gt; <span class="hljs-number">0</span> &amp;&amp; this_str_pos &lt; pos &amp;&amp;
                        (str_pos === <span class="hljs-literal">null</span> || this_str_pos &lt; str_pos)) {
                    str_pos = this_str_pos;
                    str_found = Twig.token.strings[i];
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>We found a string before the end of the token, now find the string’s end and set the search offset to it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (str_pos !== <span class="hljs-literal">null</span>) {
                end_offset = str_pos + <span class="hljs-number">1</span>;
                end = <span class="hljs-literal">null</span>;
                found = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                    end_str_pos = template.indexOf(str_found, end_offset);
                    <span class="hljs-keyword">if</span> (end_str_pos &lt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-string">"Unclosed string in template"</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Ignore escaped quotes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (template.substr(end_str_pos - <span class="hljs-number">1</span>, <span class="hljs-number">1</span>) !== <span class="hljs-string">"\\"</span>) {
                        offset = end_str_pos + <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">break</span>;
                    } <span class="hljs-keyword">else</span> {
                        end_offset = end_str_pos + <span class="hljs-number">1</span>;
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> end;
    };

    <span class="hljs-comment">/**
     * Convert a template into high-level tokens.
     */</span>
    Twig.tokenize = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">template</span>) </span>{
        <span class="hljs-keyword">var</span> tokens = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>An offset for reporting errors locations in the template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            error_offset = <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>The start and type of the first token found in the template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            found_token = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>The end position of the matched token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            end = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">while</span> (template.length &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Find the first occurance of any token type in the template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            found_token = Twig.token.findStart(template);

            Twig.log.trace(<span class="hljs-string">"Twig.tokenize: "</span>, <span class="hljs-string">"Found token: "</span>, found_token);

            <span class="hljs-keyword">if</span> (found_token.position !== <span class="hljs-literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Add a raw type token for anything before the start of the token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (found_token.position &gt; <span class="hljs-number">0</span>) {
                    tokens.push({
                        type: Twig.token.type.raw,
                        value: template.substring(<span class="hljs-number">0</span>, found_token.position)
                    });
                }
                template = template.substr(found_token.position + found_token.def.open.length);
                error_offset += found_token.position + found_token.def.open.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Find the end of the token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                end = Twig.token.findEnd(template, found_token.def, error_offset);

                Twig.log.trace(<span class="hljs-string">"Twig.tokenize: "</span>, <span class="hljs-string">"Token ends at "</span>, end);

                tokens.push({
                    type:  found_token.def.type,
                    value: template.substring(<span class="hljs-number">0</span>, end).trim()
                });

                <span class="hljs-keyword">if</span> (template.substr( end + found_token.def.close.length, <span class="hljs-number">1</span> ) === <span class="hljs-string">"\n"</span>) {
                    <span class="hljs-keyword">switch</span> (found_token.def.type) {
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"logic_whitespace_pre"</span>:
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"logic_whitespace_post"</span>:
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"logic_whitespace_both"</span>:
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"logic"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Newlines directly after logic tokens are ignored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            end += <span class="hljs-number">1</span>;
                            <span class="hljs-keyword">break</span>;
                    }
                }

                template = template.substr(end + found_token.def.close.length);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Increment the position in the template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                error_offset += end + found_token.def.close.length;

            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>No more tokens -&gt; add the rest of the template as a raw-type token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                tokens.push({
                    type: Twig.token.type.raw,
                    value: template
                });
                template = <span class="hljs-string">''</span>;
            }
        }

        <span class="hljs-keyword">return</span> tokens;
    };


    Twig.compile = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tokens</span>) </span>{
        <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Output and intermediate stacks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> output = [],
                stack = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>The tokens between open and close tags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                intermediate_output = [],

                token = <span class="hljs-literal">null</span>,
                logic_token = <span class="hljs-literal">null</span>,
                unclosed_token = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Temporary previous token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prev_token = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Temporary previous output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prev_output = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Temporary previous intermediate output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prev_intermediate_output = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>The previous token’s template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prev_template = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Token lookahead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                next_token = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>The output token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                tok_output = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Logic Token values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                type = <span class="hljs-literal">null</span>,
                open = <span class="hljs-literal">null</span>,
                next = <span class="hljs-literal">null</span>;

            <span class="hljs-keyword">var</span> compile_output = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">token</span>) </span>{
                Twig.expression.compile.apply(<span class="hljs-keyword">this</span>, [token]);
                <span class="hljs-keyword">if</span> (stack.length &gt; <span class="hljs-number">0</span>) {
                    intermediate_output.push(token);
                } <span class="hljs-keyword">else</span> {
                    output.push(token);
                }
            };

            <span class="hljs-keyword">var</span> compile_logic = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">token</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Compile the logic token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                logic_token = Twig.logic.compile.apply(<span class="hljs-keyword">this</span>, [token]);

                type = logic_token.type;
                open = Twig.logic.handler[type].open;
                next = Twig.logic.handler[type].next;

                Twig.log.trace(<span class="hljs-string">"Twig.compile: "</span>, <span class="hljs-string">"Compiled logic token to "</span>, logic_token,
                                                 <span class="hljs-string">" next is: "</span>, next, <span class="hljs-string">" open is : "</span>, open);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Not a standalone token, check logic stack to see if this is expected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (open !== <span class="hljs-literal">undefined</span> &amp;&amp; !open) {
                    prev_token = stack.pop();
                    prev_template = Twig.logic.handler[prev_token.type];

                    <span class="hljs-keyword">if</span> (Twig.indexOf(prev_template.next, type) &lt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(type + <span class="hljs-string">" not expected after a "</span> + prev_token.type);
                    }

                    prev_token.output = prev_token.output || [];

                    prev_token.output = prev_token.output.concat(intermediate_output);
                    intermediate_output = [];

                    tok_output = {
                        type: Twig.token.type.logic,
                        token: prev_token
                    };
                    <span class="hljs-keyword">if</span> (stack.length &gt; <span class="hljs-number">0</span>) {
                        intermediate_output.push(tok_output);
                    } <span class="hljs-keyword">else</span> {
                        output.push(tok_output);
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>This token requires additional tokens to complete the logic structure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (next !== <span class="hljs-literal">undefined</span> &amp;&amp; next.length &gt; <span class="hljs-number">0</span>) {
                    Twig.log.trace(<span class="hljs-string">"Twig.compile: "</span>, <span class="hljs-string">"Pushing "</span>, logic_token, <span class="hljs-string">" to logic stack."</span>);

                    <span class="hljs-keyword">if</span> (stack.length &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Put any currently held output into the output list of the logic operator
currently at the head of the stack before we push a new one on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        prev_token = stack.pop();
                        prev_token.output = prev_token.output || [];
                        prev_token.output = prev_token.output.concat(intermediate_output);
                        stack.push(prev_token);
                        intermediate_output = [];
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Push the new logic token onto the logic stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    stack.push(logic_token);

                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (open !== <span class="hljs-literal">undefined</span> &amp;&amp; open) {
                    tok_output = {
                        type: Twig.token.type.logic,
                        token: logic_token
                    };</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Standalone token (like {% set … %}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (stack.length &gt; <span class="hljs-number">0</span>) {
                        intermediate_output.push(tok_output);
                    } <span class="hljs-keyword">else</span> {
                        output.push(tok_output);
                    }
                }
            };

            <span class="hljs-keyword">while</span> (tokens.length &gt; <span class="hljs-number">0</span>) {
                token = tokens.shift();
                prev_output = output[output.length - <span class="hljs-number">1</span>];
                prev_intermediate_output = intermediate_output[intermediate_output.length - <span class="hljs-number">1</span>];
                next_token = tokens[<span class="hljs-number">0</span>];
                Twig.log.trace(<span class="hljs-string">"Compiling token "</span>, token);
                <span class="hljs-keyword">switch</span> (token.type) {
                    <span class="hljs-keyword">case</span> Twig.token.type.raw:
                        <span class="hljs-keyword">if</span> (stack.length &gt; <span class="hljs-number">0</span>) {
                            intermediate_output.push(token);
                        } <span class="hljs-keyword">else</span> {
                            output.push(token);
                        }
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> Twig.token.type.logic:
                        compile_logic.call(<span class="hljs-keyword">this</span>, token);
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Do nothing, comments should be ignored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> Twig.token.type.comment:
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> Twig.token.type.output:
                        compile_output.call(<span class="hljs-keyword">this</span>, token);
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Kill whitespace ahead and behind this token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> Twig.token.type.logic_whitespace_pre:
                    <span class="hljs-keyword">case</span> Twig.token.type.logic_whitespace_post:
                    <span class="hljs-keyword">case</span> Twig.token.type.logic_whitespace_both:
                    <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_pre:
                    <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_post:
                    <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_both:
                        <span class="hljs-keyword">if</span> (token.type !== Twig.token.type.output_whitespace_post &amp;&amp; token.type !== Twig.token.type.logic_whitespace_post) {
                            <span class="hljs-keyword">if</span> (prev_output) {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>If the previous output is raw, pop it off</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">if</span> (prev_output.type === Twig.token.type.raw) {
                                    output.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>If the previous output is not just whitespace, trim it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="hljs-keyword">if</span> (prev_output.value.match(<span class="hljs-regexp">/^\s*$/</span>) === <span class="hljs-literal">null</span>) {
                                        prev_output.value = prev_output.value.trim();</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Repush the previous output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        output.push(prev_output);
                                    }
                                }
                            }

                            <span class="hljs-keyword">if</span> (prev_intermediate_output) {</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>If the previous intermediate output is raw, pop it off</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">if</span> (prev_intermediate_output.type === Twig.token.type.raw) {
                                    intermediate_output.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>If the previous output is not just whitespace, trim it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="hljs-keyword">if</span> (prev_intermediate_output.value.match(<span class="hljs-regexp">/^\s*$/</span>) === <span class="hljs-literal">null</span>) {
                                        prev_intermediate_output.value = prev_intermediate_output.value.trim();</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Repush the previous intermediate output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        intermediate_output.push(prev_intermediate_output);
                                    }
                                }
                            }
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Compile this token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">switch</span> (token.type) {
                            <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_pre:
                            <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_post:
                            <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_both:
                                compile_output.call(<span class="hljs-keyword">this</span>, token);
                                <span class="hljs-keyword">break</span>;
                            <span class="hljs-keyword">case</span> Twig.token.type.logic_whitespace_pre:
                            <span class="hljs-keyword">case</span> Twig.token.type.logic_whitespace_post:
                            <span class="hljs-keyword">case</span> Twig.token.type.logic_whitespace_both:
                                compile_logic.call(<span class="hljs-keyword">this</span>, token);
                                <span class="hljs-keyword">break</span>;
                        }

                        <span class="hljs-keyword">if</span> (token.type !== Twig.token.type.output_whitespace_pre &amp;&amp; token.type !== Twig.token.type.logic_whitespace_pre) {
                            <span class="hljs-keyword">if</span> (next_token) {</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>If the next token is raw, shift it out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">if</span> (next_token.type === Twig.token.type.raw) {
                                    tokens.shift();</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>If the next token is not just whitespace, trim it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="hljs-keyword">if</span> (next_token.value.match(<span class="hljs-regexp">/^\s*$/</span>) === <span class="hljs-literal">null</span>) {
                                        next_token.value = next_token.value.trim();</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Unshift the next token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        tokens.unshift(next_token);
                                    }
                                }
                            }
                        }

                        <span class="hljs-keyword">break</span>;
                }

                Twig.log.trace(<span class="hljs-string">"Twig.compile: "</span>, <span class="hljs-string">" Output: "</span>, output,
                                                 <span class="hljs-string">" Logic Stack: "</span>, stack,
                                                 <span class="hljs-string">" Pending Output: "</span>, intermediate_output );
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Verify that there are no logic tokens left in the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (stack.length &gt; <span class="hljs-number">0</span>) {
                unclosed_token = stack.pop();
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Unable to find an end tag for "</span> + unclosed_token.type +
                                <span class="hljs-string">", expecting one of "</span> + unclosed_token.next);
            }
            <span class="hljs-keyword">return</span> output;
        } <span class="hljs-keyword">catch</span> (ex) {
            Twig.log.error(<span class="hljs-string">"Error compiling twig template "</span> + <span class="hljs-keyword">this</span>.id + <span class="hljs-string">": "</span>);
            <span class="hljs-keyword">if</span> (ex.stack) {
                Twig.log.error(ex.stack);
            } <span class="hljs-keyword">else</span> {
                Twig.log.error(ex.toString());
            }

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.options.rethrow) <span class="hljs-keyword">throw</span> ex;
        }
    };

    <span class="hljs-comment">/**
     * Parse a compiled template.
     *
     * @param {Array} tokens The compiled tokens.
     * @param {Object} context The render context.
     *
     * @return {string} The parsed template.
     */</span>
    Twig.parse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tokens, context</span>) </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> output = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Track logic chains</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                chain = <span class="hljs-literal">true</span>,
                that = <span class="hljs-keyword">this</span>;

            Twig.forEach(tokens, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseToken</span>(<span class="hljs-params">token</span>) </span>{
                Twig.log.debug(<span class="hljs-string">"Twig.parse: "</span>, <span class="hljs-string">"Parsing token: "</span>, token);

                <span class="hljs-keyword">switch</span> (token.type) {
                    <span class="hljs-keyword">case</span> Twig.token.type.raw:
                        output.push(Twig.filters.raw(token.value));
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> Twig.token.type.logic:
                        <span class="hljs-keyword">var</span> logic_token = token.token,
                            logic = Twig.logic.parse.apply(that, [logic_token, context, chain]);

                        <span class="hljs-keyword">if</span> (logic.chain !== <span class="hljs-literal">undefined</span>) {
                            chain = logic.chain;
                        }
                        <span class="hljs-keyword">if</span> (logic.context !== <span class="hljs-literal">undefined</span>) {
                            context = logic.context;
                        }
                        <span class="hljs-keyword">if</span> (logic.output !== <span class="hljs-literal">undefined</span>) {
                            output.push(logic.output);
                        }
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> Twig.token.type.comment:</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Do nothing, comments should be ignored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Fall through whitespace to output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_pre:
                    <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_post:
                    <span class="hljs-keyword">case</span> Twig.token.type.output_whitespace_both:
                    <span class="hljs-keyword">case</span> Twig.token.type.output:
                        Twig.log.debug(<span class="hljs-string">"Twig.parse: "</span>, <span class="hljs-string">"Output token: "</span>, token.stack);</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Parse the given expression in the given context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        output.push(Twig.expression.parse.apply(that, [token.stack, context]));
                        <span class="hljs-keyword">break</span>;
                }
            });
            <span class="hljs-keyword">return</span> Twig.output.apply(<span class="hljs-keyword">this</span>, [output]);
        } <span class="hljs-keyword">catch</span> (ex) {
            Twig.log.error(<span class="hljs-string">"Error parsing twig template "</span> + <span class="hljs-keyword">this</span>.id + <span class="hljs-string">": "</span>);
            <span class="hljs-keyword">if</span> (ex.stack) {
                Twig.log.error(ex.stack);
            } <span class="hljs-keyword">else</span> {
                Twig.log.error(ex.toString());
            }

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.options.rethrow) <span class="hljs-keyword">throw</span> ex;

            <span class="hljs-keyword">if</span> (Twig.debug) {
                <span class="hljs-keyword">return</span> ex.toString();
            }
        }
    };

    <span class="hljs-comment">/**
     * Tokenize and compile a string template.
     *
     * @param {string} data The template.
     *
     * @return {Array} The compiled tokens.
     */</span>
    Twig.prepare = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">var</span> tokens, raw_tokens;</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Tokenize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Twig.log.debug(<span class="hljs-string">"Twig.prepare: "</span>, <span class="hljs-string">"Tokenizing "</span>, data);
        raw_tokens = Twig.tokenize.apply(<span class="hljs-keyword">this</span>, [data]);</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Compile</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Twig.log.debug(<span class="hljs-string">"Twig.prepare: "</span>, <span class="hljs-string">"Compiling "</span>, raw_tokens);
        tokens = Twig.compile.apply(<span class="hljs-keyword">this</span>, [raw_tokens]);

        Twig.log.debug(<span class="hljs-string">"Twig.prepare: "</span>, <span class="hljs-string">"Compiled "</span>, tokens);

        <span class="hljs-keyword">return</span> tokens;
    };

    <span class="hljs-comment">/**
     * Join the output token's stack and escape it if needed
     *
     * @param {Array} Output token's stack
     *
     * @return {string|String} Autoescaped output
     */</span>
    Twig.output = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">output</span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.options.autoescape) {
            <span class="hljs-keyword">return</span> output.join(<span class="hljs-string">""</span>);
        }

        <span class="hljs-keyword">var</span> strategy = <span class="hljs-string">'html'</span>;
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.options.autoescape == <span class="hljs-string">'string'</span>)
            strategy = <span class="hljs-keyword">this</span>.options.autoescape;</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>[].map would be better but it’s not supported by IE8-</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> escaped_output = [];
        Twig.forEach(output, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">str</span>) </span>{
            <span class="hljs-keyword">if</span> (str &amp;&amp; (str.twig_markup !== <span class="hljs-literal">true</span> &amp;&amp; str.twig_markup != strategy)) {
                str = Twig.filters.escape(str, [ strategy ]);
            }
            escaped_output.push(str);
        });
        <span class="hljs-keyword">return</span> Twig.Markup(escaped_output.join(<span class="hljs-string">""</span>));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Namespace for template storage and retrieval</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.Templates = {
        <span class="hljs-comment">/**
         * Registered template loaders - use Twig.Templates.registerLoader to add supported loaders
         * @type {Object}
         */</span>
        loaders: {},

        <span class="hljs-comment">/**
         * Registered template parsers - use Twig.Templates.registerParser to add supported parsers
         * @type {Object}
         */</span>
        parsers: {},

        <span class="hljs-comment">/**
         * Cached / loaded templates
         * @type {Object}
         */</span>
        registry: {}
    };

    <span class="hljs-comment">/**
     * Is this id valid for a twig template?
     *
     * @param {string} id The ID to check.
     *
     * @throws {Twig.Error} If the ID is invalid or used.
     * @return {boolean} True if the ID is valid.
     */</span>
    Twig.validateId = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
        <span class="hljs-keyword">if</span> (id === <span class="hljs-string">"prototype"</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(id + <span class="hljs-string">" is not a valid twig identifier"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Twig.cache &amp;&amp; Twig.Templates.registry.hasOwnProperty(id)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">"There is already a template with the ID "</span> + id);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">/**
     * Register a template loader
     *
     * @example
     * Twig.extend(function(Twig) {
     *    Twig.Templates.registerLoader('custom_loader', function(location, params, callback, error_callback) {
     *        // ... load the template ...
     *        params.data = loadedTemplateData;
     *        // create and return the template
     *        var template = new Twig.Template(params);
     *        if (typeof callback === 'function') {
     *            callback(template);
     *        }
     *        return template;
     *    });
     * });
     * 
     * @param {String} method_name The method this loader is intended for (ajax, fs)
     * @param {Function} func The function to execute when loading the template
     * @param {Object|undefined} scope Optional scope parameter to bind func to
     *
     * @throws Twig.Error
     *
     * @return {void}
     */</span>
    Twig.Templates.registerLoader = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method_name, func, scope</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> func !== <span class="hljs-string">'function'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">'Unable to add loader for '</span> + method_name + <span class="hljs-string">': Invalid function reference given.'</span>);
        }
        <span class="hljs-keyword">if</span> (scope) {
            func = func.bind(scope);
        }
        <span class="hljs-keyword">this</span>.loaders[method_name] = func;
    };

    <span class="hljs-comment">/**
     * Remove a registered loader
     * 
     * @param {String} method_name The method name for the loader you wish to remove
     *
     * @return {void}
     */</span>
    Twig.Templates.unRegisterLoader = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method_name</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isRegisteredLoader(method_name)) {
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.loaders[method_name];
        }
    };

    <span class="hljs-comment">/**
     * See if a loader is registered by its method name
     * 
     * @param {String} method_name The name of the loader you are looking for
     *
     * @return {boolean}
     */</span>
    Twig.Templates.isRegisteredLoader = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method_name</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.loaders.hasOwnProperty(method_name);
    };

    <span class="hljs-comment">/**
     * Register a template parser
     *
     * @example
     * Twig.extend(function(Twig) {
     *    Twig.Templates.registerParser('custom_parser', function(params) {
     *        // this template source can be accessed in params.data
     *        var template = params.data
     *
     *        // ... custom process that modifies the template
     *
     *        // return the parsed template
     *        return template;
     *    });
     * });
     *
     * @param {String} method_name The method this parser is intended for (twig, source)
     * @param {Function} func The function to execute when parsing the template
     * @param {Object|undefined} scope Optional scope parameter to bind func to
     *
     * @throws Twig.Error
     *
     * @return {void}
     */</span>
    Twig.Templates.registerParser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method_name, func, scope</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> func !== <span class="hljs-string">'function'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">'Unable to add parser for '</span> + method_name + <span class="hljs-string">': Invalid function regerence given.'</span>);
        }

        <span class="hljs-keyword">if</span> (scope) {
            func = func.bind(scope);
        }

        <span class="hljs-keyword">this</span>.parsers[method_name] = func;
    };

    <span class="hljs-comment">/**
     * Remove a registered parser
     *
     * @param {String} method_name The method name for the parser you wish to remove
     *
     * @return {void}
     */</span>
    Twig.Templates.unRegisterParser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method_name</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isRegisteredParser(method_name)) {
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.parsers[method_name];
        }
    };

    <span class="hljs-comment">/**
     * See if a parser is registered by its method name
     *
     * @param {String} method_name The name of the parser you are looking for
     *
     * @return {boolean}
     */</span>
    Twig.Templates.isRegisteredParser = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">method_name</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.parsers.hasOwnProperty(method_name);
    };

    <span class="hljs-comment">/**
     * Save a template object to the store.
     *
     * @param {Twig.Template} template   The twig.js template to store.
     */</span>
    Twig.Templates.save = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">template</span>) </span>{
        <span class="hljs-keyword">if</span> (template.id === <span class="hljs-literal">undefined</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">"Unable to save template with no id"</span>);
        }
        Twig.Templates.registry[template.id] = template;
    };

    <span class="hljs-comment">/**
     * Load a previously saved template from the store.
     *
     * @param {string} id   The ID of the template to load.
     *
     * @return {Twig.Template} A twig.js template stored with the provided ID.
     */</span>
    Twig.Templates.load = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
        <span class="hljs-keyword">if</span> (!Twig.Templates.registry.hasOwnProperty(id)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> Twig.Templates.registry[id];
    };

    <span class="hljs-comment">/**
     * Load a template from a remote location using AJAX and saves in with the given ID.
     *
     * Available parameters:
     *
     *      async:       Should the HTTP request be performed asynchronously.
     *                      Defaults to true.
     *      method:      What method should be used to load the template
     *                      (fs or ajax)
     *      parser:      What method should be used to parse the template
     *                      (twig or source)
     *      precompiled: Has the template already been compiled.
     *
     * @param {string} location  The remote URL to load as a template.
     * @param {Object} params The template parameters.
     * @param {function} callback  A callback triggered when the template finishes loading.
     * @param {function} error_callback  A callback triggered if an error occurs loading the template.
     *
     *
     */</span>
    Twig.Templates.loadRemote = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">location, params, callback, error_callback</span>) </span>{
        <span class="hljs-keyword">var</span> loader;</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Default to async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (params.async === <span class="hljs-literal">undefined</span>) {
            params.async = <span class="hljs-literal">true</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Default to the URL so the template is cached.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (params.id === <span class="hljs-literal">undefined</span>) {
            params.id = location;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Check for existing template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (Twig.cache &amp;&amp; Twig.Templates.registry.hasOwnProperty(params.id)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>A template is already saved with the given id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
                callback(Twig.Templates.registry[params.id]);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>TODO: if async, return deferred promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> Twig.Templates.registry[params.id];
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>if the parser name hasn’t been set, default it to twig</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        params.parser = params.parser || <span class="hljs-string">'twig'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Assume ‘fs’ if the loader is not defined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        loader = <span class="hljs-keyword">this</span>.loaders[params.method] || <span class="hljs-keyword">this</span>.loaders.fs;
        <span class="hljs-keyword">return</span> loader.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Determine object type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is</span>(<span class="hljs-params">type, obj</span>) </span>{
        <span class="hljs-keyword">var</span> clas = <span class="hljs-built_in">Object</span>.prototype.toString.call(obj).slice(<span class="hljs-number">8</span>, <span class="hljs-number">-1</span>);
        <span class="hljs-keyword">return</span> obj !== <span class="hljs-literal">undefined</span> &amp;&amp; obj !== <span class="hljs-literal">null</span> &amp;&amp; clas === type;
    }

    <span class="hljs-comment">/**
     * Create a new twig.js template.
     *
     * Parameters: {
     *      data:   The template, either pre-compiled tokens or a string template
     *      id:     The name of this template
     *      blocks: Any pre-existing block from a child template
     * }
     *
     * @param {Object} params The template parameters.
     */</span>
    Twig.Template = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> params </span>) </span>{
        <span class="hljs-keyword">var</span> data = params.data,
            id = params.id,
            blocks = params.blocks,
            macros = params.macros || {},
            base = params.base,
            path = params.path,
            url = params.url,
            name = params.name,
            method = params.method,</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>parser options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            options = params.options;</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <h1 id="what-is-stored-in-a-twig-template">What is stored in a Twig.Template</h1>
<p>The Twig Template hold several chucks of data.</p>
<pre><code>{
     id:     The token ID (<span class="hljs-keyword">if</span> any)
     tokens: The list <span class="hljs-keyword">of</span> tokens that makes up <span class="hljs-keyword">this</span> template.
     blocks: The list <span class="hljs-keyword">of</span> block <span class="hljs-keyword">this</span> template contains.
     base:   The base template (<span class="hljs-keyword">if</span> any)
       options:  {
           Compiler/parser options

           strict_variables: <span class="hljs-literal">true</span>/<span class="hljs-literal">false</span>
               Should missing variable/keys emit an error message. If <span class="hljs-literal">false</span>, they <span class="hljs-keyword">default</span> to <span class="hljs-literal">null</span>.
       }
}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">this</span>.id     = id;
        <span class="hljs-keyword">this</span>.method = method;
        <span class="hljs-keyword">this</span>.base   = base;
        <span class="hljs-keyword">this</span>.path   = path;
        <span class="hljs-keyword">this</span>.url    = url;
        <span class="hljs-keyword">this</span>.name   = name;
        <span class="hljs-keyword">this</span>.macros = macros;
        <span class="hljs-keyword">this</span>.options = options;

        <span class="hljs-keyword">this</span>.reset(blocks);

        <span class="hljs-keyword">if</span> (is(<span class="hljs-string">'String'</span>, data)) {
            <span class="hljs-keyword">this</span>.tokens = Twig.prepare.apply(<span class="hljs-keyword">this</span>, [data]);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.tokens = data;
        }

        <span class="hljs-keyword">if</span> (id !== <span class="hljs-literal">undefined</span>) {
            Twig.Templates.save(<span class="hljs-keyword">this</span>);
        }
    };

    Twig.Template.prototype.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">blocks</span>) </span>{
        Twig.log.debug(<span class="hljs-string">"Twig.Template.reset"</span>, <span class="hljs-string">"Reseting template "</span> + <span class="hljs-keyword">this</span>.id);
        <span class="hljs-keyword">this</span>.blocks = {};
        <span class="hljs-keyword">this</span>.importedBlocks = [];
        <span class="hljs-keyword">this</span>.originalBlockTokens = {};
        <span class="hljs-keyword">this</span>.child = {
            blocks: blocks || {}
        };
        <span class="hljs-keyword">this</span>.extend = <span class="hljs-literal">null</span>;
    };

    Twig.Template.prototype.render = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">context, params</span>) </span>{
        params = params || {};

        <span class="hljs-keyword">var</span> output,
            url;

        <span class="hljs-keyword">this</span>.context = context || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Clear any previous state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.reset();
        <span class="hljs-keyword">if</span> (params.blocks) {
            <span class="hljs-keyword">this</span>.blocks = params.blocks;
        }
        <span class="hljs-keyword">if</span> (params.macros) {
            <span class="hljs-keyword">this</span>.macros = params.macros;
        }

        output = Twig.parse.apply(<span class="hljs-keyword">this</span>, [<span class="hljs-keyword">this</span>.tokens, <span class="hljs-keyword">this</span>.context]);</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Does this template extend another</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.extend) {
            <span class="hljs-keyword">var</span> ext_template;</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>check if the template is provided inline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.options.allowInlineIncludes ) {
                ext_template = Twig.Templates.load(<span class="hljs-keyword">this</span>.extend);
                <span class="hljs-keyword">if</span> ( ext_template ) {
                    ext_template.options = <span class="hljs-keyword">this</span>.options;
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>check for the template file via include</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!ext_template) {
                url = Twig.path.parsePath(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.extend);

                ext_template = Twig.Templates.loadRemote(url, {
                    method: <span class="hljs-keyword">this</span>.getLoaderMethod(),
                    base: <span class="hljs-keyword">this</span>.base,
                    <span class="hljs-keyword">async</span>:  <span class="hljs-literal">false</span>,
                    id:     url,
                    options: <span class="hljs-keyword">this</span>.options
                });
            }

            <span class="hljs-keyword">this</span>.parent = ext_template;

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.parent.render(<span class="hljs-keyword">this</span>.context, {
                blocks: <span class="hljs-keyword">this</span>.blocks
            });
        }

        <span class="hljs-keyword">if</span> (params.output == <span class="hljs-string">'blocks'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.blocks;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (params.output == <span class="hljs-string">'macros'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.macros;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> output;
        }
    };

    Twig.Template.prototype.importFile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>) </span>{
        <span class="hljs-keyword">var</span> url, sub_template;
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.url &amp;&amp; <span class="hljs-keyword">this</span>.options.allowInlineIncludes) {
            file = <span class="hljs-keyword">this</span>.path ? <span class="hljs-keyword">this</span>.path + <span class="hljs-string">'/'</span> + file : file;
            sub_template = Twig.Templates.load(file);

            <span class="hljs-keyword">if</span> (!sub_template) {
                sub_template = Twig.Templates.loadRemote(url, {
                    id: file,
                    method: <span class="hljs-keyword">this</span>.getLoaderMethod(),
                    <span class="hljs-keyword">async</span>: <span class="hljs-literal">false</span>,
                    options: <span class="hljs-keyword">this</span>.options
                });

                <span class="hljs-keyword">if</span> (!sub_template) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">"Unable to find the template "</span> + file);
                }
            }

            sub_template.options = <span class="hljs-keyword">this</span>.options;

            <span class="hljs-keyword">return</span> sub_template;
        }

        url = Twig.path.parsePath(<span class="hljs-keyword">this</span>, file);</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Load blocks from an external file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sub_template = Twig.Templates.loadRemote(url, {
            method: <span class="hljs-keyword">this</span>.getLoaderMethod(),
            base: <span class="hljs-keyword">this</span>.base,
            <span class="hljs-keyword">async</span>: <span class="hljs-literal">false</span>,
            options: <span class="hljs-keyword">this</span>.options,
            id: url
        });

        <span class="hljs-keyword">return</span> sub_template;
    };

    Twig.Template.prototype.importBlocks = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, override</span>) </span>{
        <span class="hljs-keyword">var</span> sub_template = <span class="hljs-keyword">this</span>.importFile(file),
            context = <span class="hljs-keyword">this</span>.context,
            that = <span class="hljs-keyword">this</span>,
            key;

        override = override || <span class="hljs-literal">false</span>;

        sub_template.render(context);</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Mixin blocks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Twig.forEach(<span class="hljs-built_in">Object</span>.keys(sub_template.blocks), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>) </span>{
            <span class="hljs-keyword">if</span> (override || that.blocks[key] === <span class="hljs-literal">undefined</span>) {
                that.blocks[key] = sub_template.blocks[key];
                that.importedBlocks.push(key);
            }
        });
    };

    Twig.Template.prototype.importMacros = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>) </span>{
        <span class="hljs-keyword">var</span> url = Twig.path.parsePath(<span class="hljs-keyword">this</span>, file);</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>load remote template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> remoteTemplate = Twig.Templates.loadRemote(url, {
            method: <span class="hljs-keyword">this</span>.getLoaderMethod(),
            <span class="hljs-keyword">async</span>: <span class="hljs-literal">false</span>,
            id: url
        });

        <span class="hljs-keyword">return</span> remoteTemplate;
    };

    Twig.Template.prototype.getLoaderMethod = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.path) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'fs'</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.url) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'ajax'</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.method || <span class="hljs-string">'fs'</span>;
    };

    Twig.Template.prototype.compile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>compile the template into raw JS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> Twig.compiler.compile(<span class="hljs-keyword">this</span>, options);
    };

    <span class="hljs-comment">/**
     * Create safe output
     *
     * @param {string} Content safe to output
     *
     * @return {String} Content wrapped into a String
     */</span>

    Twig.Markup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">content, strategy</span>) </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> strategy == <span class="hljs-string">'undefined'</span>) {
            strategy = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> content === <span class="hljs-string">'string'</span> &amp;&amp; content.length &gt; <span class="hljs-number">0</span>) {
            content = <span class="hljs-keyword">new</span> <span class="hljs-built_in">String</span>(content);
            content.twig_markup = strategy;
        }
        <span class="hljs-keyword">return</span> content;
    };

    <span class="hljs-keyword">return</span> Twig;

}) (Twig || { });

(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Twig</span>) </span>{
<span class="hljs-meta">
    'use strict'</span>;

    Twig.Templates.registerLoader(<span class="hljs-string">'ajax'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">location, params, callback, error_callback</span>) </span>{
        <span class="hljs-keyword">var</span> template,
            xmlhttp,
            precompiled = params.precompiled,
            parser = <span class="hljs-keyword">this</span>.parsers[params.parser] || <span class="hljs-keyword">this</span>.parser.twig;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> XMLHttpRequest === <span class="hljs-string">"undefined"</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">'Unsupported platform: Unable to do ajax requests '</span> +
                                 <span class="hljs-string">'because there is no "XMLHTTPRequest" implementation'</span>);
        }

        xmlhttp = <span class="hljs-keyword">new</span> XMLHttpRequest();
        xmlhttp.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> data = <span class="hljs-literal">null</span>;

            <span class="hljs-keyword">if</span>(xmlhttp.readyState === <span class="hljs-number">4</span>) {
                <span class="hljs-keyword">if</span> (xmlhttp.status === <span class="hljs-number">200</span> || (<span class="hljs-built_in">window</span>.cordova &amp;&amp; xmlhttp.status == <span class="hljs-number">0</span>)) {
                    Twig.log.debug(<span class="hljs-string">"Got template "</span>, xmlhttp.responseText);

                    <span class="hljs-keyword">if</span> (precompiled === <span class="hljs-literal">true</span>) {
                        data = <span class="hljs-built_in">JSON</span>.parse(xmlhttp.responseText);
                    } <span class="hljs-keyword">else</span> {
                        data = xmlhttp.responseText;
                    }

                    params.url = location;
                    params.data = data;

                    template = parser.call(<span class="hljs-keyword">this</span>, params);

                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
                        callback(template);
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> error_callback === <span class="hljs-string">'function'</span>) {
                        error_callback(xmlhttp);
                    }
                }
            }
        };
        xmlhttp.open(<span class="hljs-string">"GET"</span>, location, !!params.async);
        xmlhttp.send();

        <span class="hljs-keyword">if</span> (params.async) {</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>TODO: return deferred promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> template;
        }
    });

}(Twig));(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Twig</span>) </span>{
<span class="hljs-meta">    'use strict'</span>;

    <span class="hljs-keyword">var</span> fs, path;

    <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>require lib dependencies at runtime</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    	fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
    	path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
    } <span class="hljs-keyword">catch</span> (e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>NOTE: this is in a try/catch to avoid errors cross platform</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    Twig.Templates.registerLoader(<span class="hljs-string">'fs'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">location, params, callback, error_callback</span>) </span>{
        <span class="hljs-keyword">var</span> template,
            data = <span class="hljs-literal">null</span>,
            precompiled = params.precompiled,
            parser = <span class="hljs-keyword">this</span>.parsers[params.parser] || <span class="hljs-keyword">this</span>.parser.twig;

        <span class="hljs-keyword">if</span> (!fs || !path) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">'Unsupported platform: Unable to load from file '</span> +
                                 <span class="hljs-string">'because there is no "fs" or "path" implementation'</span>);
        }

        <span class="hljs-keyword">var</span> loadTemplateFn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> error_callback === <span class="hljs-string">'function'</span>) {
                    error_callback(err);
                }
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-keyword">if</span> (precompiled === <span class="hljs-literal">true</span>) {
                data = <span class="hljs-built_in">JSON</span>.parse(data);
            }

            params.data = data;
            params.path = params.path || location;</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>template is in data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            template = parser.call(<span class="hljs-keyword">this</span>, params);

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
                callback(template);
            }
        };
        params.path = params.path || location;

        <span class="hljs-keyword">if</span> (params.async) {
            fs.stat(params.path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, stats</span>) </span>{
                <span class="hljs-keyword">if</span> (err || !stats.isFile()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">'Unable to find template file '</span> + location);
                }
                fs.readFile(params.path, <span class="hljs-string">'utf8'</span>, loadTemplateFn);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>TODO: return deferred promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (!fs.statSync(params.path).isFile()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Twig.Error(<span class="hljs-string">'Unable to find template file '</span> + location);
            }
            data = fs.readFileSync(params.path, <span class="hljs-string">'utf8'</span>);
            loadTemplateFn(<span class="hljs-literal">undefined</span>, data);
            <span class="hljs-keyword">return</span> template
        }
    });

}(Twig));(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Twig</span>)</span>{
<span class="hljs-meta">    'use strict'</span>;

    Twig.Templates.registerParser(<span class="hljs-string">'source'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">params</span>) </span>{
        <span class="hljs-keyword">return</span> params.data || <span class="hljs-string">''</span>;
    });
})(Twig);
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Twig</span>)</span>{
<span class="hljs-meta">    'use strict'</span>;

    Twig.Templates.registerParser(<span class="hljs-string">'twig'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">params</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Twig.Template(params);
    });
})(Twig);</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>The following methods are from MDN and are available under a
<a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> or are
<a href="https://developer.mozilla.org/Project:Copyrights">Public Domain</a>.</p>
<p>See:</p>
<ul>
<li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object/keys">Object.keys - MDN</a></li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <h2 id="twig-fills-js">twig.fills.js</h2>
<p>This file contains fills for backwards compatability.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
<span class="hljs-meta">    "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Handle methods that don’t yet exist in every browser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">String</span>.prototype.trim) {
        <span class="hljs-built_in">String</span>.prototype.trim = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.replace(<span class="hljs-regexp">/^\s+|\s+$/g</span>,<span class="hljs-string">''</span>);
        }
    };

    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">Object</span>.keys) <span class="hljs-built_in">Object</span>.keys = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">o</span>)</span>{
        <span class="hljs-keyword">if</span> (o !== <span class="hljs-built_in">Object</span>(o)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'Object.keys called on non-object'</span>);
        }
        <span class="hljs-keyword">var</span> ret = [], p;
        <span class="hljs-keyword">for</span> (p <span class="hljs-keyword">in</span> o) <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(o, p)) ret.push(p);
        <span class="hljs-keyword">return</span> ret;
    }

})();</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <h2 id="twig-lib-js">twig.lib.js</h2>
<p>This file contains 3rd party libraries used within twig.</p>
<p>Copies of the licenses for the code included here can be found in the
LICENSES.md file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Twig = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">Twig</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Namespace for libraries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.lib = { };

    <span class="hljs-comment">/**
    sprintf() for JavaScript 1.0.3
    https://github.com/alexei/sprintf.js
    **/</span>
    <span class="hljs-keyword">var</span> sprintfLib = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> re = {
            not_string: <span class="hljs-regexp">/[^s]/</span>,
            number: <span class="hljs-regexp">/[diefg]/</span>,
            json: <span class="hljs-regexp">/[j]/</span>,
            not_json: <span class="hljs-regexp">/[^j]/</span>,
            text: <span class="hljs-regexp">/^[^\x25]+/</span>,
            modulo: <span class="hljs-regexp">/^\x25{2}/</span>,
            placeholder: <span class="hljs-regexp">/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijosuxX])/</span>,
            key: <span class="hljs-regexp">/^([a-z_][a-z_\d]*)/i</span>,
            key_access: <span class="hljs-regexp">/^\.([a-z_][a-z_\d]*)/i</span>,
            index_access: <span class="hljs-regexp">/^\[(\d+)\]/</span>,
            sign: <span class="hljs-regexp">/^[\+\-]/</span>
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sprintf</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> key = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>], cache = sprintf.cache
            <span class="hljs-keyword">if</span> (!(cache[key] &amp;&amp; cache.hasOwnProperty(key))) {
                cache[key] = sprintf.parse(key)
            }
            <span class="hljs-keyword">return</span> sprintf.format.call(<span class="hljs-literal">null</span>, cache[key], <span class="hljs-built_in">arguments</span>)
        }

        sprintf.format = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">parse_tree, argv</span>) </span>{
            <span class="hljs-keyword">var</span> cursor = <span class="hljs-number">1</span>, tree_length = parse_tree.length, node_type = <span class="hljs-string">""</span>, arg, output = [], i, k, match, pad, pad_character, pad_length, is_positive = <span class="hljs-literal">true</span>, sign = <span class="hljs-string">""</span>
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; tree_length; i++) {
                node_type = get_type(parse_tree[i])
                <span class="hljs-keyword">if</span> (node_type === <span class="hljs-string">"string"</span>) {
                    output[output.length] = parse_tree[i]
                }
                <span class="hljs-keyword">else</span